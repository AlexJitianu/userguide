<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic PUBLIC "-//OASIS//DTD DITA Topic//EN" "topic.dtd">
<topic id="custom-refactoring-xquery-script">
  <title>Custom Refactoring XQuery Update Script</title>
  <body>
    <p>The first step in creating a custom refactoring operation is to create an XQuery Update
      script. The easiest way to create this file is to use the <b>New</b> document wizard and
      create a new <b>XQuery</b>
      file.<?oxy_delete author="radu_pisoi" timestamp="20150317T113704+0200" content=" You can then use the example below to help you create the XQuery file. "?></p>
    <?oxy_insert_start author="radu_pisoi" timestamp="20150317T113804+0200"?>
    <p>There are cases when it is necessary to add parameters in the XQuery script. For instance,
      when you want to rename an element you may want to declare an external parameter associated
      with the name of the element to rename. You should be able to specify the value for these
      parameters, so they should be declared in the
      <?oxy_comment_start author="radu_pisoi" timestamp="20150317T121457+0200" comment="This should be a link to the topic with the operation descriptor."?>refactoring
      operation descriptor<?oxy_comment_end?> associated with this operation.</p>
    <note>The XQuery Update processing is disabled by default in <ph keyref="product"/>. So, if you
      want to develop an XQuery Update script you have to enable this facility by creating an
      <?oxy_comment_start author="radu_pisoi" timestamp="20150318T093751+0200" comment="Link to XQuery transf scenario topic"?>XQuery
      transformation scenario<?oxy_comment_end?> for it and choose the Saxon EE as a transformation
      engine. Furthermore, you have to select the <uicontrol>Enable XQuery update</uicontrol> option
      in the
      <?oxy_comment_start author="radu_pisoi" timestamp="20150318T093708+0200" comment="Link to options pages"?>Saxon
      processor advanced options<?oxy_comment_end?>.</note>
    <?oxy_insert_end?>
    <p>To demonstrate creating a custom operation, consider that we have a task where we need to
      convert an attribute into an element and insert it inside another element. A specific
      <?oxy_delete author="radu_pisoi" timestamp="20150318T094908+0200" content="example"?><?oxy_insert_start author="radu_pisoi" timestamp="20150318T094911+0200"?>use-case<?oxy_insert_end?>
      would be if you have a project with a variety of <codeph>image</codeph> elements where a
      deprecated <codeph>alt</codeph> attribute was used for the description and you want to convert
      all instances of that attribute into an element with the same name and insert it as the first
      child of the <codeph>image</codeph> element. </p>
    <p>To achieve this, the XQuery Update script iterates over all elements from the document that
      have the specified local name and namespace. Then it finds the attribute that will be
      converted to an element. It then computes the <term>QName</term> of the new element to be
      inserted and inserts it as the first child of the parent element.</p>
    <p>In our example, we created the custom operation to use parameters that can be specified in
      the dialog box that is displayed after selecting the custom operation in <xref
        href="xml-refactoring-tool.dita#xml-refactoring-tool/refactoring_operations_dlentry">the
          <uicontrol>Refactoring operations</uicontrol> dialog box</xref>. Since various parameters
      can be<?oxy_delete author="radu_pisoi" timestamp="20150318T094952+0200" content=" it"?>
      specified, this custom operation can also be used for other similar tasks. The following image
      shows the parameters that can be specified in our example of the custom operation to convert
      an attribute to an element:<fig id="fig_vsr_3fd_jr">
        <image href="../img/custom_refactoring_operation.png" id="image_tsb_lfd_jr"/>
      </fig></p>
    <example>
      <title>Sample XQuery Update Script for Creating a Custom Operation to <i>Convert an Attribute
          to an Element</i>
      </title>
      <codeblock outputclass="language-xml">(: 
    XQuery document used to implement 'Convert attribute to element' operation from XML Refactoring tool.
:)

declare namespace output = "http://www.w3.org/2010/xslt-xquery-serialization";
declare option output:method   "xml";
declare option output:indent   "no"; 

(: Local name of the attribute's parent element. :)
declare variable $element_localName as xs:string external;

(: Namespace of the attribute's parent element. :)
declare variable $element_namespace as xs:string external;

(: The local name of the attribute to be converted :)
declare variable $attribute_localName as xs:string external;

(: The namespace of the attribute to be converted :)
declare variable $attribute_namespace as xs:string external;

(: Local name of the new element. :)
declare variable $new_element_localName as xs:string external;

(: Namespace of the new element. :)
declare variable $new_element_namespace as xs:string external;

(: Convert attribute to element:)
for $node in //*
(: Find the attribute to convert :)
let $attribute := 
    $node/@*[local-name() = $attribute_localName and
    ($attribute_namespace = '&lt;ANY>' or $attribute_namespace = namespace-uri())]
    
(: Compute the prefix for the new element to insert :)
let $prefix := 
    for $p in in-scope-prefixes($node)
      where $new_element_namespace = namespace-uri-for-prefix($p, $node)
return $p

(: Compute the qname for the new element to insert :)    
let $new_element_qName :=
    if (empty($prefix) or $prefix[1] = '') then $new_element_localName
    else $prefix[1] || ':' || $new_element_localName
    
  where ('&lt;ANY>' = $element_localName or local-name($node) = $element_localName) and 
        ($element_namespace = '&lt;ANY>' or $element_namespace = namespace-uri($node))
        
  return 
      if (exists($attribute)) then
        (insert node element {QName($new_element_namespace, $new_element_qName)} 
        {string($attribute)} as first into $node,
        delete node $attribute)
        else ()</codeblock>
    </example>
    <p>The next step in creating a custom refactoring operation is to <xref
        href="xml-refactoring-operation-descriptor.dita">create a custom operation descriptor
        file</xref>.</p>
  </body>
</topic>
<?oxy_options track_changes="on"?>